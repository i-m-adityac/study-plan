<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive FAANG Study Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'brand-primary': '#1e293b', // slate-800
                        'brand-secondary': '#334155', // slate-700
                        'brand-accent': '#38bdf8', // sky-400
                        'light-bg': '#f1f5f9', // slate-100
                        'light-surface': '#ffffff', // white
                        'light-text-primary': '#1e293b', // slate-800
                        'light-text-secondary': '#64748b', // slate-500
                        'dark-bg': '#0f172a', // slate-900
                        'dark-surface': '#1e293b', // slate-800
                        'dark-text-primary': '#f1f5f9', // slate-100
                        'dark-text-secondary': '#94a3b8', // slate-400
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .task-input, .time-input {
            background-color: transparent;
            border: none;
            width: 100%;
            padding: 4px 8px;
            margin: -4px -8px;
            border-radius: 6px;
        }
        .task-input:focus, .time-input:focus {
            outline: 2px solid var(--tw-prose-brand-accent);
            background-color: var(--tw-prose-light-surface);
        }
        .dark .task-input:focus, .dark .time-input:focus {
             background-color: var(--tw-prose-dark-surface);
        }
        .tag-selector {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: transparent;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
        }
        .task-completed .time-input, .task-completed .task-input {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.8;
        }
        .dark input[type="date"]::-webkit-calendar-picker-indicator {
           filter: invert(1);
        }
        .task-tag { color: #1e293b; }
        .dark .task-tag { color: #f8fafc; }
    </style>
</head>
<body class="bg-light-bg dark:bg-dark-bg text-light-text-secondary dark:text-dark-text-secondary antialiased">

    <div class="flex flex-col md:flex-row min-h-screen">
        <!-- Sidebar -->
        <aside class="w-full md:w-80 bg-white dark:bg-dark-surface p-6 border-b md:border-r border-slate-200 dark:border-slate-700 flex-shrink-0">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-2xl font-bold text-light-text-primary dark:text-dark-text-primary">FAANG Planner</h1>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                    <svg id="theme-icon-light" class="w-6 h-6 text-slate-600 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="theme-icon-dark" class="w-6 h-6 text-slate-600 dark:text-slate-400 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
            
            <div id="strategy-guide">
                <h2 class="text-sm font-semibold uppercase text-slate-400 dark:text-slate-500 tracking-wider mb-4">Strategic Guide</h2>
                <div class="space-y-2" id="accordion-container">
                    <!-- Accordion items will be injected here -->
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 sm:p-6 md:p-8">
            <div class="max-w-3xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <button id="prev-day" class="p-2 rounded-full bg-white dark:bg-dark-surface hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors border border-slate-200 dark:border-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <input type="date" id="date-picker" class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-brand-accent bg-white dark:bg-dark-surface text-lg font-semibold text-light-text-primary dark:text-dark-text-primary text-center">
                    <button id="next-day" class="p-2 rounded-full bg-white dark:bg-dark-surface hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors border border-slate-200 dark:border-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>

                <div id="plan-container">
                    <!-- Daily plan will be injected here -->
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const planContainer = document.getElementById('plan-container');
        const datePicker = document.getElementById('date-picker');
        const prevDayButton = document.getElementById('prev-day');
        const nextDayButton = document.getElementById('next-day');
        const accordionContainer = document.getElementById('accordion-container');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        
        const startDate = new Date('2025-08-16T00:00:00Z'); // Use UTC for consistency
        const totalDays = 182;
        
        const taskTags = {
            dsa: { light: '#bae6fd', dark: '#0ea5e9', name: 'DSA' },
            sys: { light: '#a7f3d0', dark: '#10b981', name: 'System Design' },
            review: { light: '#fde68a', dark: '#f59e0b', name: 'Revision' },
            behavioral: { light: '#c7d2fe', dark: '#6366f1', name: 'Behavioral' },
            mock: { light: '#fecdd3', dark: '#f43f5e', name: 'Mock Interview' },
            planning: { light: '#e2e8f0', dark: '#64748b', name: 'Planning' }
        };

        const strategyGuideContent = [
            { title: "The SDE II Mindset", content: "The leap to SDE II is about evolving from a coder to an architect and owner. Focus on demonstrating ownership, dealing with ambiguity, and architectural thinking." },
            { title: "Technical Pillars", content: "Study DSA and System Design in parallel. For DSA, focus on pattern recognition. For System Design, master the building blocks of scalable systems." },
            { title: "Behavioral Excellence", content: "Structure your stories using the STAR method. Calibrate your stories to an SDE II level by focusing on impact and scope. Prepare stories that align with 'Googlyness'." },
            { title: "Secondary Priorities", content: "Leverage your professional experience instead of starting new side projects. For AI/ML, demonstrate awareness of components as black-box services, not deep expertise." },
            { title: "Curated Resources", content: "DSA: CCI, HelloInterview, LeetCode. System Design: Gaurav Sen, Alex Xu's book, DDIA. Mocks: Pramp." }
        ];

        function renderStrategyGuide() {
            accordionContainer.innerHTML = strategyGuideContent.map(item => `
                <div class="accordion-item">
                    <button class="accordion-header w-full flex justify-between items-center text-left font-semibold text-light-text-primary dark:text-dark-text-primary py-2">
                        <span>${item.title}</span>
                        <svg class="w-5 h-5 transform transition-transform duration-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content text-sm text-light-text-secondary dark:text-dark-text-secondary">
                        <p class="pt-2 pb-2 pr-4">${item.content}</p>
                    </div>
                </div>
            `).join('');
        }

        function generateFullPlan() {
            const plan = {};
            const dsaTopics = ["Arrays & Hashing", "Two Pointers", "Sliding Window", "Stacks", "Binary Search", "Linked Lists", "Trees", "Tries", "Heaps", "Backtracking", "Graphs", "Advanced Graphs", "1-D DP", "2-D DP", "Intervals", "Greedy", "Bit Manipulation"];
            let dsaTopicIndex = 0;

            for (let i = 0; i < totalDays; i++) {
                const currentDate = new Date(startDate.getTime());
                currentDate.setUTCDate(startDate.getUTCDate() + i);
                const dateString = currentDate.toISOString().split('T')[0];
                const dayOfWeek = currentDate.getUTCDay();
                const weekNum = Math.floor(i / 7);
                let dailySchedule = [];

                if (i < 14) { // First two weeks are hyper-specific
                    if (dateString === '2025-08-16') {
                        dailySchedule = [
                            { time: '9:00 AM - 11:00 AM', task: 'DSA: Solve LC 1 (Two Sum) & LC 242 (Valid Anagram)', type: 'dsa', link: 'https://leetcode.com/problemset/', completed: false },
                            { time: '11:00 AM - 1:00 PM', task: 'DSA: Solve LC 49 (Group Anagrams)', type: 'dsa', link: 'https://leetcode.com/problems/group-anagrams/', completed: false },
                            { time: '2:00 PM - 4:00 PM', task: 'Sys Design: Watch Gaurav Sen on Primer & Load Balancers', type: 'sys', link: 'https://www.youtube.com/watch?v=fMZadjdA_2s', completed: false },
                            { time: '5:00 PM - 6:00 PM', task: 'Review: Time/space complexity of today\'s problems', type: 'review', link: '', completed: false }
                        ];
                    } else if (dateString === '2025-08-17') {
                         dailySchedule = [
                            { time: '9:00 AM - 11:00 AM', task: 'Active Recall: Re-solve "Group Anagrams" on whiteboard', type: 'review', link: 'https://leetcode.com/problems/group-anagrams/', completed: false },
                            { time: '11:00 AM - 1:00 PM', task: 'Sys Design: Whiteboard TinyURL design', type: 'sys', link: 'https://www.youtube.com/watch?v=fMZadjdA_2s', completed: false },
                            { time: '2:00 PM - 3:00 PM', task: 'Behavioral: Draft Situation & Task for first STAR story', type: 'behavioral', link: '', completed: false },
                            { time: '5:00 PM - 6:00 PM', task: 'Backup Slot / Planning', type: 'planning', link: '', completed: false }
                        ];
                    } else if (dateString === '2025-08-18') {
                        dailySchedule = [
                            { time: '9:00 PM - 10:30 PM', task: 'DSA: Solve LC 125 (Valid Palindrome)', type: 'dsa', link: 'https://leetcode.com/problems/valid-palindrome/', completed: false },
                            { time: '10:30 PM - 11:00 PM', task: 'Sys Design: Watch Gaurav Sen on Caching', type: 'sys', link: 'https://www.youtube.com/watch?v=N_1_N63s_0M', completed: false },
                            { time: '11:00 PM - 11:30 PM', task: 'Backup Slot', type: 'planning', link: '', completed: false }
                        ];
                    } else if (dateString === '2025-08-19') {
                        dailySchedule = [
                            { time: '9:00 PM - 10:30 PM', task: 'DSA: Solve LC 15 (3Sum)', type: 'dsa', link: 'https://leetcode.com/problems/3sum/', completed: false },
                            { time: '10:30 PM - 11:00 PM', task: 'Spaced Repetition: Review Hash Map patterns', type: 'review', link: '', completed: false },
                            { time: '11:00 PM - 11:30 PM', task: 'Backup Slot', type: 'planning', link: '', completed: false }
                        ];
                    } else if (dateString === '2025-08-20') {
                        dailySchedule = [
                            { time: '9:00 PM - 10:30 PM', task: 'DSA: Solve LC 11 (Container With Most Water)', type: 'dsa', link: 'https://leetcode.com/problems/container-with-most-water/', completed: false },
                            { time: '10:30 PM - 11:00 PM', task: 'Sys Design: Watch Gaurav Sen on Databases', type: 'sys', link: 'https://www.youtube.com/watch?v=y-vL0kGjLpQ', completed: false },
                            { time: '11:00 PM - 11:30 PM', task: 'Backup Slot', type: 'planning', link: '', completed: false }
                        ];
                    } else if (dateString === '2025-08-21') {
                        dailySchedule = [
                            { time: '9:00 PM - 10:30 PM', task: 'DSA: Solve LC 121 (Best Time to Buy and Sell Stock)', type: 'dsa', link: 'https://leetcode.com/problems/best-time-to-buy-and-sell-stock/', completed: false },
                            { time: '10:30 PM - 11:00 PM', task: 'Spaced Repetition: Review Caching & Load Balancing', type: 'review', link: '', completed: false },
                            { time: '11:00 PM - 11:30 PM', task: 'Backup Slot', type: 'planning', link: '', completed: false }
                        ];
                    } else if (dateString === '2025-08-22') {
                        dailySchedule = [
                            { time: '9:00 PM - 10:30 PM', task: 'Behavioral: Complete STAR story (Action & Result)', type: 'behavioral', link: '', completed: false },
                            { time: '10:30 PM - 11:00 PM', task: 'Weekly Review: Takeaways from Two Pointers pattern', type: 'review', link: '', completed: false },
                            { time: '11:00 PM - 11:30 PM', task: 'Backup Slot', type: 'planning', link: '', completed: false }
                        ];
                    } else if (dateString === '2025-08-23') {
                        dailySchedule = [
                            { time: '9:00 AM - 1:00 PM', task: 'DSA (Sliding Window): Solve LC 3, LC 424', type: 'dsa', link: 'https://leetcode.com/problemset/', completed: false },
                            { time: '2:00 PM - 4:00 PM', task: 'Sys Design: Watch Gaurav Sen on Sharding & CDNs', type: 'sys', link: 'https://www.youtube.com/playlist?list=PLMCXHnjXnTnvo5-L0_2FzKscWgT1_AZE0', completed: false },
                            { time: '5:00 PM - 6:00 PM', task: 'Review: Sliding Window template (expand/shrink conditions)', type: 'review', link: '', completed: false }
                        ];
                    } else if (dateString === '2025-08-24') {
                        dailySchedule = [
                            { time: '9:00 AM - 11:00 AM', task: 'Active Recall: Re-solve LC 3 on whiteboard', type: 'review', link: 'https://leetcode.com/problems/longest-substring-without-repeating-characters/', completed: false },
                            { time: '11:00 AM - 1:00 PM', task: 'Sys Design: Whiteboard Instagram Feed', type: 'sys', link: '', completed: false },
                            { time: '2:00 PM - 3:00 PM', task: 'Behavioral: Refine first STAR story (Action section)', type: 'behavioral', link: '', completed: false },
                            { time: '5:00 PM - 6:00 PM', task: 'Backup Slot / Planning', type: 'planning', link: '', completed: false }
                        ];
                    } else if (dateString === '2025-08-25') {
                        dailySchedule = [
                            { time: '9:00 PM - 10:30 PM', task: 'DSA (Stacks): Solve LC 20 (Valid Parentheses)', type: 'dsa', link: 'https://leetcode.com/problems/valid-parentheses/', completed: false },
                            { time: '10:30 PM - 11:00 PM', task: 'Sys Design: Watch Gaurav Sen on Message Queues', type: 'sys', link: 'https://www.youtube.com/watch?v=O_xT4Jb_Gk8', completed: false },
                            { time: '11:00 PM - 11:30 PM', task: 'Backup Slot', type: 'planning', link: '', completed: false }
                        ];
                    } else if (dateString === '2025-08-26') {
                        dailySchedule = [
                            { time: '9:00 PM - 10:30 PM', task: 'DSA (Stacks): Solve LC 155 (Min Stack)', type: 'dsa', link: 'https://leetcode.com/problems/min-stack/', completed: false },
                            { time: '10:30 PM - 11:00 PM', task: 'Spaced Repetition: Review Two Pointers pattern', type: 'review', link: '', completed: false },
                            { time: '11:00 PM - 11:30 PM', task: 'Backup Slot', type: 'planning', link: '', completed: false }
                        ];
                    } else if (dateString === '2025-08-27') {
                        dailySchedule = [
                            { time: '9:00 PM - 10:30 PM', task: 'DSA (Stacks): Solve LC 739 (Daily Temperatures)', type: 'dsa', link: 'https://leetcode.com/problems/daily-temperatures/', completed: false },
                            { time: '10:30 PM - 11:00 PM', task: 'Sys Design: Watch Gaurav Sen on API Gateways', type: 'sys', link: 'https://www.youtube.com/watch?v=T4D_0tG1P7s', completed: false },
                            { time: '11:00 PM - 11:30 PM', task: 'Backup Slot', type: 'planning', link: '', completed: false }
                        ];
                    } else if (dateString === '2025-08-28') {
                        dailySchedule = [
                            { time: '9:00 PM - 10:30 PM', task: 'DSA (Stacks): Solve LC 853 (Car Fleet)', type: 'dsa', link: 'https://leetcode.com/problems/car-fleet/', completed: false },
                            { time: '10:30 PM - 11:00 PM', task: 'Spaced Repetition: Review Sharding & CDNs', type: 'review', link: '', completed: false },
                            { time: '11:00 PM - 11:30 PM', task: 'Backup Slot', type: 'planning', link: '', completed: false }
                        ];
                    } else if (dateString === '2025-08-29') {
                        dailySchedule = [
                            { time: '9:00 PM - 10:30 PM', task: 'Behavioral: Write new STAR story (disagreement)', type: 'behavioral', link: '', completed: false },
                            { time: '10:30 PM - 11:00 PM', task: 'Weekly Review: Takeaways from Stacks pattern', type: 'review', link: '', completed: false },
                            { time: '11:00 PM - 11:30 PM', task: 'Backup Slot', type: 'planning', link: '', completed: false }
                        ];
                    }
                } else { // Procedural generation for the rest
                    const isWeekend = (dayOfWeek === 6 || dayOfWeek === 0);
                    const month = Math.floor(i / 30);

                    if (month < 4) { // Phase 1 & 2
                        if (isWeekend) {
                            if (dayOfWeek === 6) {
                                const topic = dsaTopics[dsaTopicIndex++ % dsaTopics.length] || "Advanced Topics";
                                dailySchedule.push({ time: '9:00 AM - 1:00 PM', task: `DSA Deep Dive: ${topic}`, type: 'dsa' });
                                dailySchedule.push({ time: '2:00 PM - 4:00 PM', task: `System Design: New Topic (e.g., Read Alex Xu Ch ${weekNum - 1})`, type: 'sys' });
                            } else {
                                dailySchedule.push({ time: '9:00 AM - 11:00 AM', task: `Weekly DSA Review: Re-solve 2 problems from this week`, type: 'review' });
                                dailySchedule.push({ time: '11:00 AM - 1:00 PM', task: `System Design: Whiteboard a system (e.g., Instagram)`, type: 'sys' });
                                dailySchedule.push({ time: '2:00 PM - 3:00 PM', task: `Behavioral Prep: Write/Refine one STAR story`, type: 'behavioral' });
                            }
                        } else {
                            dailySchedule.push({ time: '9:00 PM - 10:30 PM', task: `DSA Practice: 1-2 LeetCode problems (Medium)`, type: 'dsa' });
                            if (i % 3 === 0) { // Spaced repetition for system design
                                dailySchedule.push({ time: '10:30 PM - 11:00 PM', task: `Spaced Revision: Review past System Design notes`, type: 'review' });
                            } else {
                                dailySchedule.push({ time: '10:30 PM - 11:00 PM', task: `System Design: Read one chapter or watch one short video`, type: 'sys' });
                            }
                        }
                    } else if (month === 4) { // Phase 3: Mocks
                         if (dayOfWeek === 2 || dayOfWeek === 4) { // Tue/Thu
                            dailySchedule = [{ time: '9:00 PM - 10:30 PM', task: 'Live Mock Interview (Pramp)', type: 'mock' }, { time: '10:30 PM - 11:00 PM', task: 'Analyze Mock Feedback', type: 'review' }];
                        } else if (dayOfWeek === 6) {
                            dailySchedule = [
                                { time: '9:00 AM - 12:00 PM', task: 'Double Mock Session (DSA + System Design)', type: 'mock' },
                                { time: '1:00 PM - 3:00 PM', task: 'Deep Dive on Mock Feedback', type: 'review' }
                            ];
                        } else {
                             dailySchedule.push({ time: '9:00 PM - 11:00 PM', task: 'Targeted Practice based on Mock Feedback', type: 'dsa' });
                        }
                    } else { // Phase 4: Final Prep
                        if (isWeekend) {
                            dailySchedule.push({ time: '9:00 AM - 12:00 PM', task: 'Full Mock Loop Simulation (3 interviews)', type: 'mock' });
                        } else {
                            dailySchedule.push({ time: '9:00 PM - 11:00 PM', task: 'Solve Google-tagged LeetCode problems', type: 'dsa' });
                        }
                    }

                    if (isWeekend) {
                        dailySchedule.push({ time: '5:00 PM - 6:00 PM', task: 'Backup Slot / Catch-up', type: 'planning' });
                    } else {
                        dailySchedule.push({ time: '11:00 PM - 11:30 PM', task: 'Backup Slot / Catch-up', type: 'planning' });
                    }
                }
                plan[dateString] = dailySchedule.map(task => {
                    let link = '';
                    if (task.type === 'dsa') link = 'https://leetcode.com/problemset/';
                    else if (task.type === 'sys') link = 'https://www.youtube.com/playlist?list=PLMCXHnjXnTnvo5-L0_2FzKscWgT1_AZE0';
                    else if (task.type === 'mock') link = 'https://www.pramp.com/';
                    return { ...task, link: link, completed: false };
                });
            }
            return plan;
        }
        
        let studyPlan = JSON.parse(localStorage.getItem('studyPlan')) || generateFullPlan();
        let currentDate = new Date(startDate);

        function savePlan() {
            localStorage.setItem('studyPlan', JSON.stringify(studyPlan));
        }

        function renderCurrentDay() {
            const dateString = currentDate.toISOString().split('T')[0];
            datePicker.value = dateString;
            planContainer.innerHTML = '';

            const dailySchedule = studyPlan[dateString] || [];
            
            const dayCard = document.createElement('div');
            dayCard.className = 'bg-light-surface dark:bg-dark-surface rounded-xl shadow-lg p-6';
            dayCard.dataset.date = dateString;
            
            const dayHeader = document.createElement('h3');
            dayHeader.className = 'font-bold text-2xl mb-6 text-light-text-primary dark:text-dark-text-primary';
            dayHeader.textContent = currentDate.toLocaleString('en-US', { timeZone: 'UTC', weekday: 'long', month: 'long', day: 'numeric' });
            dayCard.appendChild(dayHeader);
            
            const tasksContainer = document.createElement('div');
            tasksContainer.className = 'space-y-4';

            dailySchedule.forEach((item, index) => {
                const isDark = document.documentElement.classList.contains('dark');
                const taskColor = isDark ? taskTags[item.type]?.dark : taskTags[item.type]?.light;

                const taskDiv = document.createElement('div');
                taskDiv.className = `flex items-center p-3 rounded-lg space-x-4 border border-transparent ${item.completed ? 'task-completed' : ''}`;
                taskDiv.style.backgroundColor = taskColor || '#e2e8f0';
                taskDiv.dataset.index = index;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = item.completed;
                checkbox.className = 'flex-shrink-0 h-5 w-5 rounded text-brand-accent focus:ring-brand-accent border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700';
                
                const tagSelector = document.createElement('select');
                tagSelector.className = 'tag-selector flex-shrink-0';
                tagSelector.style.backgroundColor = taskColor || '#e2e8f0';
                for(const tagKey in taskTags) {
                    const option = document.createElement('option');
                    option.value = tagKey;
                    option.textContent = taskTags[tagKey].name;
                    if(tagKey === item.type) option.selected = true;
                    tagSelector.appendChild(option);
                }
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'flex-grow flex flex-col sm:flex-row sm:items-center task-tag';
                
                const timeInput = document.createElement('input');
                timeInput.type = 'text';
                timeInput.value = item.time;
                timeInput.className = 'time-input font-semibold sm:w-2/5';
                timeInput.dataset.field = 'time';
                
                const taskInput = document.createElement('input');
                taskInput.type = 'text';
                taskInput.value = item.task;
                taskInput.className = 'task-input sm:w-3/5 sm:ml-4 mt-1 sm:mt-0';
                taskInput.dataset.field = 'task';
                
                contentDiv.appendChild(timeInput);
                contentDiv.appendChild(taskInput);
                
                const linkContainer = document.createElement('div');
                linkContainer.className = 'link-container flex-shrink-0 ml-auto pl-2';
                if (item.link) {
                    const link = document.createElement('a');
                    link.href = item.link;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    link.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>`;
                    link.className = 'link-button text-slate-400 hover:text-brand-accent';
                    linkContainer.appendChild(link);
                }
                
                taskDiv.appendChild(checkbox);
                taskDiv.appendChild(tagSelector);
                taskDiv.appendChild(contentDiv);
                taskDiv.appendChild(linkContainer);
                tasksContainer.appendChild(taskDiv);
            });
            
            dayCard.appendChild(tasksContainer);
            planContainer.appendChild(dayCard);
        }

        planContainer.addEventListener('change', (e) => {
            const target = e.target;
            const taskDiv = target.closest('[data-index]');
            if (!taskDiv) return;
            const dayCard = target.closest('[data-date]');
            const date = dayCard.dataset.date;
            const index = taskDiv.dataset.index;
            if (target.type === 'checkbox') {
                studyPlan[date][index].completed = target.checked;
                taskDiv.classList.toggle('task-completed', target.checked);
            } else if (target.classList.contains('tag-selector')) {
                const newType = target.value;
                studyPlan[date][index].type = newType;
                const isDark = document.documentElement.classList.contains('dark');
                const newColor = isDark ? taskTags[newType].dark : taskTags[newType].light;
                taskDiv.style.backgroundColor = newColor;
                target.style.backgroundColor = newColor;
            } else if (target.classList.contains('time-input') || target.classList.contains('task-input')) {
                studyPlan[date][index][target.dataset.field] = target.value;
            }
            savePlan();
        });

        planContainer.addEventListener('click', (e) => {
            const taskInput = e.target.closest('.task-input');
            if (taskInput) {
                const dayCard = taskInput.closest('[data-date]');
                const taskDiv = taskInput.closest('[data-index]');
                const date = dayCard.dataset.date;
                const index = taskDiv.dataset.index;
                
                const currentLink = studyPlan[date][index].link || '';
                const newLink = prompt('Enter a URL for this task (or leave empty to remove):', currentLink);

                if (newLink !== null) {
                    studyPlan[date][index].link = newLink.trim();
                    savePlan();
                    renderCurrentDay();
                }
            }
        });
        
        prevDayButton.addEventListener('click', () => {
            currentDate.setUTCDate(currentDate.getUTCDate() - 1);
            renderCurrentDay();
        });

        nextDayButton.addEventListener('click', () => {
            currentDate.setUTCDate(currentDate.getUTCDate() + 1);
            renderCurrentDay();
        });

        datePicker.addEventListener('change', (e) => {
            const [year, month, day] = e.target.value.split('-').map(Number);
            currentDate = new Date(Date.UTC(year, month - 1, day));
            renderCurrentDay();
        });

        accordionContainer.addEventListener('click', (e) => {
            const header = e.target.closest('.accordion-header');
            if (header) {
                const content = header.nextElementSibling;
                const icon = header.querySelector('svg');
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                    icon.style.transform = 'rotate(180deg)';
                }
            }
        });

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIconLight.classList.add('hidden');
                themeIconDark.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeIconLight.classList.remove('hidden');
                themeIconDark.classList.add('hidden');
            }
            renderCurrentDay(); // Re-render to apply new tag colors
        }

        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            const newTheme = isDark ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(savedTheme || (systemPrefersDark ? 'dark' : 'light'));

        renderStrategyGuide();
        renderCurrentDay();
    });
    </script>
</body>
</html>
